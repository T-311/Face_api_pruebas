<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camera and Image Comparison</title>
    <style>
      video,
      canvas,
      img {
        max-width: 45%;
      }
      canvas {
        position: absolute;
      }
      .link-section {
        margin-top: 20px;
      }
      a {
        color: blue;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <h2>Camera</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="overlayCanvas"></canvas>

    <h2>Upload Image</h2>
    <input type="file" id="imageUpload" accept="image/*" />
    <img id="uploadedImage" alt="Uploaded Image" />

    <button id="compareButton">Compare Images</button>
    <div id="comparisonResult"></div>

    <!-- Links Section -->
    <div class="link-section">
      <h2>Useful Links</h2>
      <a href="https://example.com" target="_blank">Visit Example</a>
      <br />
      <a href="https://face-api.js.org" target="_blank">Learn more about Face API</a>
    </div>

    <!-- Carga del script de face-api desde CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const video = document.getElementById("video");
        const overlayCanvas = document.getElementById("overlayCanvas");
        const imageUpload = document.getElementById("imageUpload");
        const uploadedImage = document.getElementById("uploadedImage");
        const compareButton = document.getElementById("compareButton");
        const comparisonResult = document.getElementById("comparisonResult");
        let uploadedFaceData;

        // Load models after face-api.js is loaded
        (async () => {
          await faceapi.nets.ssdMobilenetv1.loadFromUri("/models");
          await faceapi.nets.faceLandmark68Net.loadFromUri("/models");
          await faceapi.nets.faceRecognitionNet.loadFromUri("/models");
          startVideo();
        })();

        // Start the camera
        function startVideo() {
          navigator.mediaDevices
            .getUserMedia({ video: true })
            .then((stream) => {
              video.srcObject = stream;
            })
            .catch((err) => {
              console.error("Error accessing the camera: ", err);
              alert("Could not access the camera.");
            });
        }

        // Handle image upload and face detection
        imageUpload.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (file) {
            const img = await faceapi.bufferToImage(file);
            uploadedImage.src = img.src;
            uploadedFaceData = await faceapi
              .detectSingleFace(img)
              .withFaceLandmarks()
              .withFaceDescriptor();

            if (!uploadedFaceData) {
              alert("No face detected in the uploaded image.");
            }
          }
        });

        // Compare faces
        compareButton.addEventListener("click", async () => {
          const displaySize = { width: video.width, height: video.height };
          faceapi.matchDimensions(overlayCanvas, displaySize);

          const detections = await faceapi
            .detectAllFaces(video)
            .withFaceLandmarks()
            .withFaceDescriptors();

          if (detections.length === 0) {
            alert("No faces detected in the video feed.");
            return;
          }

          const resizedDetections = faceapi.resizeResults(detections, displaySize);
          overlayCanvas
            .getContext("2d")
            .clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
          faceapi.draw.drawDetections(overlayCanvas, resizedDetections);
          faceapi.draw.drawFaceLandmarks(overlayCanvas, resizedDetections);

          if (!uploadedFaceData) {
            alert("No face data from the uploaded image.");
            return;
          }

          const faceMatcher = new faceapi.FaceMatcher(uploadedFaceData);
          const results = resizedDetections.map((d) =>
            faceMatcher.findBestMatch(d.descriptor)
          );

          results.forEach((result, i) => {
            const { box } = resizedDetections[i].detection;
            const drawBox = new faceapi.draw.DrawBox(box, {
              label: result.toString(),
            });
            drawBox.draw(overlayCanvas);

            // Update result text
            comparisonResult.innerText =
              result.label === "unknown"
                ? "The faces do not match."
                : "The faces match!";
          });
        });
      });
    </script>
  </body>
</html>
